---
import BaseLayout from '../../layouts/BaseLayout.astro';
import contactImg from '../../assets/images/products/workshop-craft.jpg';
import '../../assets/styles/pages/contact.css';

const { lang = 'en' } = Astro.props;
const isPT = lang?.startsWith('pt');

const SITE_URL = 'https://example.com'; // change later

// ✅ GitHub Pages base path (e.g. /website-samsara)
const basePath = import.meta.env.BASE_URL?.replace(/\/$/, "") || "";
const href = (path: string) => `${basePath}${path}`;

// ✅ language-aware thank-you page (on your site)
const thankYouPath = isPT ? '/pt/thank-you' : '/en/thank-you';
const thankYouHref = href(thankYouPath);

// ✅ Formspree endpoint (paste yours here)
const FORM_ENDPOINT = "https://formspree.io/f/mbdyjrya";

const t = {
  en: {
    h1: 'Get In Touch',
    intro: "We’re here to help with any questions or requests.",
    name: 'Name',
    email: 'Email',
    phone: 'Phone (Optional)',
    message: 'Message',
    send: 'Send Message',
    sending: 'Sending…',
    success: 'Thanks — your message has been sent.',
    error: 'Sorry — something went wrong. Please try again.',
  },
  pt: {
    h1: 'Fale Connosco',
    intro: 'Estamos aqui para ajudar com qualquer questão ou pedido.',
    name: 'Nome',
    email: 'Email',
    phone: 'Telefone (Opcional)',
    message: 'Mensagem',
    send: 'Enviar Mensagem',
    sending: 'A enviar…',
    success: 'Obrigado — a sua mensagem foi enviada.',
    error: 'Ocorreu um erro. Por favor tente novamente.',
  },
};

const copy = isPT ? t.pt : t.en;
---

<BaseLayout lang={isPT ? 'pt' : 'en'} currentPage="contact">
  <section class="contact-shell" aria-label={isPT ? 'Contacto' : 'Contact'}>
    <div class="contact-card">
      <div class="contact-left">
        <h1 class="contact-title">{copy.h1}</h1>
        <p class="contact-subtitle">{copy.intro}</p>

        {/* ✅ Formspree form (same fields, same CSS) */}
        <form
          class="contact-form"
          method="POST"
          action={FORM_ENDPOINT}
          data-formspree
        >
          {/* Honeypot (spam trap) — Formspree supports this pattern */}
          <input type="text" name="_gotcha" style="display:none" tabindex="-1" autocomplete="off" />

          <div class="field">
            <label class="label" for="name">{copy.name}:</label>
            <div class="input-wrap">
              <input id="name" name="name" type="text" placeholder={copy.name} autocomplete="name" required />
            </div>
          </div>

          <div class="field">
            <label class="label" for="email">{copy.email}:</label>
            <div class="input-wrap">
              <input id="email" name="email" type="email" placeholder={copy.email} autocomplete="email" required />
            </div>
          </div>

          <div class="field">
            <label class="label" for="phone">{copy.phone}:</label>
            <div class="input-wrap">
              <input id="phone" name="phone" type="tel" placeholder={copy.phone} autocomplete="tel" inputmode="tel" />
            </div>
          </div>

          <div class="field">
            <label class="label" for="message">{copy.message}:</label>
            <div class="input-wrap textarea-wrap">
              <textarea id="message" name="message" placeholder={copy.message} required></textarea>
            </div>
          </div>

          <button class="submit-btn" type="submit">{copy.send}</button>

          {/* optional status line (won’t break layout if you style it or leave it plain) */}
          <p class="form-status" data-status aria-live="polite"></p>
        </form>
      </div>

      {/* right side unchanged */}
      <aside class="contact-right">
        <img
          src={contactImg.src}
          width={contactImg.width}
          height={contactImg.height}
          alt={isPT ? 'Oficina de carpintaria...' : 'Woodworking workshop...'}
          loading="lazy"
          decoding="async"
        />
      </aside>
    </div>
  </section>
</BaseLayout>

<script define:vars={{ thankYouHref, sendingText: copy.sending, successText: copy.success, errorText: copy.error }}>
  // Formspree AJAX submit + redirect (works on GitHub Pages)
  // Based on Formspree’s recommended AJAX approach.  [oai_citation:4‡Formspree Help](https://help.formspree.io/hc/en-us/articles/360013470814-Submit-forms-with-JavaScript-AJAX)
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.querySelector("form[data-formspree]");
    if (!(form instanceof HTMLFormElement)) return;

    const statusEl = form.querySelector("[data-status]");
    const submitBtn = form.querySelector('button[type="submit"]');

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (statusEl) statusEl.textContent = sendingText || "";
      if (submitBtn instanceof HTMLButtonElement) submitBtn.disabled = true;

      try {
        const res = await fetch(form.action, {
          method: "POST",
          body: new FormData(form),
          headers: { Accept: "application/json" },
        });

        if (res.ok) {
          if (statusEl) statusEl.textContent = successText || "";
          window.location.href = thankYouHref; // ✅ your existing /en/thank-you or /pt/thank-you (BASE_URL safe)
          return;
        }

        if (statusEl) statusEl.textContent = errorText || "";
      } catch {
        if (statusEl) statusEl.textContent = errorText || "";
      } finally {
        if (submitBtn instanceof HTMLButtonElement) submitBtn.disabled = false;
      }
    });
  });
</script>